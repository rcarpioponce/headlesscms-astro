---
import * as wp from '../../lib/wp';
import '../../styles/global.css';
import '../../styles/post.css';
import { transformHtmlImages } from '../../utils/transformHtmlImages';
import Layout from '../../layouts/Layout.astro';
import HeroImage from '../../components/HeroImage.astro';
import Breadcrumbs from '../../components/Breadcrumbs.astro';
import ReadingTime from '../../components/ReadingTime.astro';
import { calculateReadingTime } from '../../utils/readingTime';

export async function getStaticPaths() {
  // Usamos la función que obtiene todos los posts para generar todas las rutas
  const posts = await wp.fetchAllPosts();
  return posts.map((p) => ({ params: { slug: p.slug } }));
}

const { slug } = Astro.params;
const post = await wp.fetchPostBySlug(slug!);
if (!post) return Astro.redirect('/404');

// Obtener información del autor
const author = await wp.getPostAuthor(post);

const fm = wp.getFeatured(post._embedded?.['wp:featuredmedia']);
const hero = wp.buildResponsiveFromWp(fm, {
  maxWidth: 2048,
  sizes: '(max-width: 768px) 100vw, 800px'
});

// Transformar el contenido para agregar lazy loading a las imágenes
let transformedContent = '';
if (post.content?.rendered) {
  transformedContent = transformHtmlImages(post.content.rendered);
}

const title = post.title.rendered;
const formattedDate = new Date(post.date).toLocaleDateString('es-ES', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});

// Crear meta description desde el excerpt, limpiando HTML
const metaDescription = post.excerpt.rendered
  .replace(/<[^>]*>/g, '') // Remover HTML
  .replace(/\s+/g, ' ') // Normalizar espacios
  .trim()
  .slice(0, 160); // Limitar a 160 caracteres

// Calcular tiempo de lectura del contenido completo
const readingTime = calculateReadingTime(
  post.content?.rendered || post.excerpt.rendered
);

// URL de la imagen destacada para Open Graph
const ogImage = fm?.source_url || '/favicon.svg';

// Preparar datos para Schema.org
const siteUrl = Astro.site || 'https://headlesscms.byteinnovalabs.xyz';
const postUrl = new URL(`/blog/${post.slug}/`, siteUrl).toString();

const articleSchema = {
  headline: title,
  description: metaDescription,
  image: ogImage,
  datePublished: post.date,
  dateModified: post.date, // WordPress no siempre tiene modified date
  author: {
    name: author?.name || 'Autor desconocido',
    url: author ? `${siteUrl}/author/${author.slug}` : undefined
  },
  publisher: {
    name: 'Aprende cada día más',
    logo: `${siteUrl}/favicon.svg`
  },
  url: postUrl
};

const breadcrumbs = [
  { name: 'Inicio', url: siteUrl },
  { name: 'Blog', url: `${siteUrl}/` },
  { name: title, url: postUrl }
].map(item => ({
  ...item,
  url: typeof item.url === 'string' ? item.url : item.url.toString()
}));
---
<Layout 
  title={`${title} | Aprende cada día más`}
  description={metaDescription}
  image={ogImage}
  type="article"
  keywords={`tecnología, programación, desarrollo web, ${title.toLowerCase()}`}
>
  <Fragment slot="head">
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "Article",
      ...articleSchema
    }, null, 2)}></script>
    
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": breadcrumbs.map((crumb, index) => ({
        "@type": "ListItem",
        "position": index + 1,
        "name": crumb.name,
        "item": crumb.url
      }))
    }, null, 2)}></script>
  </Fragment>
  <div class="post-container">
    <Breadcrumbs items={breadcrumbs} />
    <a href="/" class="back-link">← Volver</a>
    <article>
      <header class="post-header">
        <h1 set:html={post.title.rendered} />
        <div class="post-meta">
          <time datetime={post.date}>{formattedDate}</time>
          {author && (
            <span class="post-author">
              • Por <strong>{author.name}</strong>
            </span>
          )}
          <span class="post-reading-time">
            • <ReadingTime readingTime={readingTime} />
          </span>
        </div>
      </header>
      {hero && <HeroImage hero={hero} priority={true} />}
      <div class="post-content" set:html={transformedContent || post.content?.rendered} />
    </article>
  </div>
</Layout>
